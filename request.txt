Some changes from feature-request branch